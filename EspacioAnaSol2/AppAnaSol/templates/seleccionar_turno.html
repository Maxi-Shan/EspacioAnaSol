<!DOCTYPE html>
<html lang="es">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario de Turnos</title>
    <!-- Enlaces a las librerías -->
    <link rel="stylesheet" href="{% static 'css/fondo.css' %}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.9.3/css/bulma.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tachyons/4.14.1/css/tachyons.min.css">
    <style>
        .day {
            cursor: pointer;
            margin: 5px;
            padding: 10px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .ocupado {
            background-color: rgba(255, 0, 0, 0.5);
            pointer-events: none; /* Deshabilita el clic en días ocupados */
        }
        .disponible {
            background-color: rgba(0, 255, 0, 0.5);
        }
        .hora {
            margin: 5px;
            padding: 5px;
            cursor: pointer;
            border-radius: 5px;
            background-color: #f0f0f0;
        }
        .selected {
            background-color: #3273dc;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title has-text-centered">Seleccionar Turno</h1>
        
        <!-- Calendario -->
        <div id="calendar" class="columns is-multiline"></div>
        
        <!-- Horas disponibles -->
        <div id="horas-container" class="mt4"></div> <!-- Contenedor para las horas -->
        
        <!-- Botones de navegación -->
        <div class="buttons mt-5">
            <button id="btn-volver" class="button is-warning">Volver</button>
            <button id="btn-siguiente" class="button is-primary" disabled>Siguiente</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        let fechasOcupadas = []; // Fechas ocupadas desde la base de datos
        let horasDisponibles = {}; // Objeto para almacenar horas por fecha
        let mesActual = new Date().getMonth(); // Mes actual
        let añoActual = new Date().getFullYear(); // Año actual
        let fechaSeleccionada = null;
        let horaSeleccionada = null;

        $(document).ready(function() {
    const servicioId = '{{ servicio_id }}'; // Asegúrate de que esto esté pasando el ID correctamente

    // Línea de depuración para verificar el valor de servicioId
    console.log('Servicio ID:', servicioId);

    generarCalendario(); // Generar el calendario

    // Botón Volver
    $('#btn-volver').click(function() {
        window.location.href = '{% url "seleccionar_servicio" %}'; // Redirigir a la selección de servicios
    });

    // Botón Siguiente
    $('#btn-siguiente').click(function() {
        if (fechaSeleccionada && horaSeleccionada) {
            window.location.href = `/servicio/${servicioId}/turno/registrar/?fecha=${fechaSeleccionada}&hora=${horaSeleccionada}`;
            console.log(`Redirigiendo a: /servicio/${servicioId}/turno/registrar/?fecha=${fechaSeleccionada}&hora=${horaSeleccionada}`); // Para depurar
        } else {
            console.log('Fecha o hora no seleccionadas'); // Para depurar
        }
    });
});




        function generarCalendario() {
            $('#calendar').empty(); // Limpiar el calendario actual
            $('#horas-container').empty(); // Limpiar el contenedor de horas

            // Título del mes
            $('#calendar').append(`<h2 class="subtitle has-text-centered">${getNombreMes(mesActual)} ${añoActual}</h2>`);
            
            // Botones para cambiar de mes
            const btnPrev = $('<button class="button is-small">◀️</button>').click(() => cambiarMes(-1));
            const btnNext = $('<button class="button is-small">▶️</button>').click(() => cambiarMes(1));
            $('#calendar').append(btnPrev);
            $('#calendar').append(btnNext);

            // Crear los días del mes
            const diasEnMes = new Date(añoActual, mesActual + 1, 0).getDate(); // Días en el mes
            for (let dia = 1; dia <= diasEnMes; dia++) {
                const fechaCompleta = new Date(añoActual, mesActual, dia);
                const fechaString = fechaCompleta.toISOString().split('T')[0]; // Formato YYYY-MM-DD

                // Crear botón para el día
                const dayBtn = $('<div class="day box column is-one-fifth has-text-centered"></div>').text(dia);
                if (fechasOcupadas.includes(fechaString)) {
                    dayBtn.addClass('ocupado'); // Días ocupados
                } else {
                    dayBtn.addClass('disponible'); // Días disponibles
                    dayBtn.click(() => seleccionarDia(dia, fechaString)); // Asignar evento al día
                }
                $('#calendar').append(dayBtn);
            }
        }

        function getNombreMes(mes) {
            const nombresMeses = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            return nombresMeses[mes];
        }

        function cambiarMes(cambio) {
            mesActual += cambio;
            if (mesActual < 0) {
                mesActual = 11; // Volver a diciembre
                añoActual--; // Restar un año
            } else if (mesActual > 11) {
                mesActual = 0; // Volver a enero
                añoActual++; // Sumar un año
            }
            generarCalendario();
        }

        function seleccionarDia(dia, fechaString) {
            fechaSeleccionada = fechaString; // Almacena la fecha seleccionada
            $('#horas-container').empty(); // Limpiar las horas al seleccionar un nuevo día
            $('#horas-container').append('<h3 class="subtitle">Cargando horas disponibles...</h3>');

            // Realizar la solicitud AJAX para obtener horas registradas
            $.ajax({
                url: '/obtener_horas/', // Ruta de la vista que devolverá las horas
                method: 'GET',
                data: { fecha: fechaString },
                success: function(data) {
                    $('#horas-container').empty(); // Limpiar contenedor de horas
                    $('#horas-container').append('<h3 class="subtitle">Horas Disponibles</h3>');

                    if (data.horas.length > 0) {
                        data.horas.forEach(hora => {
                            const horaBtn = $('<button class="button is-small"></button>').text(hora).click(function() {
                                horaSeleccionada = hora;
                                $('.button.is-small').removeClass('selected'); // Quitar selección de horas anteriores
                                $(this).addClass('selected'); // Seleccionar la hora actual
                                habilitarBotonSiguiente(); // Verificar si se puede habilitar el botón "Siguiente"
                            });
                            $('#horas-container').append(horaBtn);
                        });
                    } else {
                        $('#horas-container').append('<p>No hay horas disponibles para esta fecha.</p>');
                    }
                },
                error: function() {
                    $('#horas-container').empty().append('<p>Error al cargar las horas.</p>');
                }
            });
        }

        function habilitarBotonSiguiente() {
            if (fechaSeleccionada && horaSeleccionada) {
                $('#btn-siguiente').removeAttr('disabled'); // Habilitar el botón "Siguiente"
            }
        }
    </script>
</body>
</html>